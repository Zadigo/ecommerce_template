{% extends "../index.html" %}

{% block content %}
<div id="images_app">
    <div class="row d-none">
        <div class="col-md-6 mb-6">
            <div class="card">
                <filtercomponent />
            </div>
        </div>
    </div>
    
    <div class="row wow fadin">
        {% comment %}
            {% for image in images %}
                <div class="col-md-3 mb-3">
                    <div class="card">
                        <img class="card-img-top" src="{{ image.image_url|default:'https://via.placeholder.com/800' }}" alt="image">
                    </div>
                </div>
            {% endfor %}
        {% endcomment %}
        <imagescomponent v-bind:images="images" />
    </div>
    <div class="csrf">{% csrf_token %}</div>
</div>


<div class="row wow fadeIn">
    <div class="col-md-12 mb-12">
        {% include "../components/navs/pagination.html" with href="manage_images" %}
    </div>
</div>
{% endblock %}

{% block vuejs_scripts %}
    {{ vue_images|json_script:"vue_images" }}
    <script>
        var csrf = $(".csrf input").val()
        var filtercomponent = {
            template: "\
            <select name='' id=''>\
                <option value='something'>Something</option>\
            </select>\
            "
        }

        var imagescomponent = {
            props: ["images"],
            template: "\
            <div class='row'>\
                <div v-if='!image.deleted' v-for='image in images' :key='image.slug' class='col-md-3 mb-3'>\
                    <div class='card'>\
                        <img class='card-img-top' :src='image.url' :alt='image.slug'>\
                        <i @click='deleteimage(image)' class='fa fa-trash'></i>\
                    </div>\
                </div>\
            </div>\
            ",
            methods: {
                deleteimage: function(image) {
                    var self = this
                    var formdata = new FormData()
                    formdata.append("csrfmiddlewaretoken", csrf)
                    formdata.append("image_id", image.pk)

                    var xhr = new XMLHttpRequest()
                    xhr.onloadend = function() {image.deleted = true}
                    xhr.open("POST", window.location.href)
                    xhr.send(formdata)
                }
            }
        }

        var imagesapp = new Vue({
            el: "#images_app",
            components: {imagescomponent, filtercomponent},
            delimiters: ["[[", "]]"],
            data() {
                return {
                    images: []
                }
            },
            beforeMount() {
                var images = JSON.parse($("#vue_images").text())
                images.forEach(image => {
                    image["deleted"] = false
                })
                this.$data.images = images
            }
        })
    </script>
{% endblock %}